# DuckDB 文件查看器 - 开发计划

## 项目概述

基于 DuckDB 的 macOS 桌面应用程序，用于加载、预览和查询多种格式的数据文件。

## 技术选型

### 核心框架
- **Python 3.9+**: 开发语言
- **DuckDB**: 高性能分析型数据库，支持直接查询 CSV、Parquet、JSON 文件
- **CustomTkinter**: 现代化的 GUI 框架，提供美观的界面
- **Pandas**: 数据处理和结果转换

### 为什么选择这些技术？
1. **DuckDB**: 
   - 支持直接查询文件，无需导入
   - 高性能的列式存储引擎
   - 支持多种文件格式
   - 内存数据库，适合桌面应用

2. **CustomTkinter**:
   - 基于 tkinter，Python 内置
   - 现代化的界面风格
   - 跨平台支持（包括 macOS）
   - 易于使用和维护

## 项目结构

```
file-viewer/
├── main.py              # 主程序入口
├── gui.py               # GUI 界面模块
├── file_manager.py      # 文件管理模块
├── db_manager.py        # 数据库管理模块
├── requirements.txt     # 依赖包列表
├── README.md           # 项目说明文档
└── 开发计划.md          # 本文档
```

## 功能模块设计

### 1. 数据库管理模块 (db_manager.py)
**职责**: 管理 DuckDB 连接和查询执行

**主要功能**:
- 创建和管理数据库连接（内存数据库）
- 执行 SQL 查询
- 结果格式转换（DataFrame、字典列表）

### 2. 文件管理模块 (file_manager.py)
**职责**: 处理文件加载和管理

**主要功能**:
- 加载单个文件（CSV、Parquet、JSON）
- 加载文件夹中的所有支持文件
- 文件预览（前 N 行数据）
- 表信息获取（列名、行数等）
- 文件卸载（删除表）
- 表名生成和管理

**技术细节**:
- 使用 DuckDB 的 `read_csv_auto`、`read_parquet`、`read_json_objects` 函数
- 自动处理文件路径中的特殊字符
- 支持 JSONL（行分隔 JSON）格式

### 3. GUI 界面模块 (gui.py)
**职责**: 用户界面和交互

**界面布局**:
- **左侧面板**: 文件列表，显示所有已加载的文件
- **右上区域**: 文件预览，显示选中文件的前 50 行数据
- **右下区域**: SQL 查询区域
  - SQL 输入框
  - 执行查询按钮
  - 导出按钮（JSON/CSV）
  - 查询结果显示区域

**主要功能**:
- 文件选择对话框
- 文件列表管理
- 文件预览显示
- SQL 查询执行
- 结果展示和导出
- 错误处理和用户提示

### 4. 主程序 (main.py)
**职责**: 程序入口和初始化

## 实现细节

### 文件加载流程

1. 用户选择文件或文件夹
2. 文件管理器验证文件格式
3. 生成有效的表名（基于文件名）
4. 使用 DuckDB 函数加载文件到内存表
5. 更新文件列表显示
6. 自动显示文件预览

### SQL 查询流程

1. 用户在 SQL 输入框输入查询语句
2. 点击执行按钮
3. 数据库管理器执行查询
4. 结果转换为字典列表
5. 格式化显示在结果区域
6. 支持导出为 JSON 或 CSV

### 错误处理

- 文件加载失败：显示错误消息
- SQL 查询错误：在结果区域显示错误信息
- 文件格式不支持：提示用户
- 路径问题：自动处理特殊字符

## 开发步骤

### 阶段 1: 核心功能实现 ✅
- [x] 数据库管理模块
- [x] 文件管理模块
- [x] 基础 GUI 框架

### 阶段 2: 界面完善 ✅
- [x] 文件列表显示
- [x] 文件预览功能
- [x] SQL 查询界面
- [x] 结果展示

### 阶段 3: 高级功能 ✅
- [x] 文件夹批量加载
- [x] 结果导出功能
- [x] 错误处理
- [x] 用户提示

### 阶段 4: 优化和测试
- [ ] 性能优化
- [ ] 大文件处理
- [ ] 用户体验优化
- [ ] 单元测试

## 已知限制

1. **内存限制**: 所有数据存储在内存中，大文件可能占用大量内存
2. **JSON 格式**: 主要支持 JSONL（行分隔）格式，其他格式可能需要调整
3. **表名冲突**: 同名文件会生成不同的表名（添加数字后缀）
4. **线程安全**: DuckDB 连接不是线程安全的，但 GUI 操作在主线程中执行

## 未来改进方向

1. **持久化存储**: 支持将数据保存到磁盘数据库
2. **查询历史**: 保存和重用 SQL 查询
3. **数据可视化**: 添加图表展示功能
4. **多文件连接**: 支持 JOIN 多个文件
5. **性能优化**: 大文件的分块加载
6. **主题切换**: 支持深色/浅色主题切换

## 使用示例

### 加载文件
1. 点击"加载文件"按钮
2. 选择 CSV、Parquet 或 JSON 文件
3. 文件自动加载并显示在列表中

### 执行查询
```sql
-- 查看所有数据
SELECT * FROM table_name LIMIT 100;

-- 条件查询
SELECT * FROM table_name WHERE column_name > 100;

-- 聚合查询
SELECT column_name, COUNT(*) 
FROM table_name 
GROUP BY column_name;
```

### 导出结果
1. 执行查询后，点击"导出为 JSON"或"导出为 CSV"
2. 选择保存位置
3. 结果保存到指定文件

## 总结

项目已完成核心功能的实现，包括：
- ✅ 文件加载（单个文件和文件夹）
- ✅ 多格式支持（CSV、Parquet、JSON）
- ✅ 文件预览
- ✅ SQL 查询
- ✅ 结果导出

代码结构清晰，模块化设计，易于维护和扩展。

